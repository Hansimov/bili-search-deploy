services:
  bili-search-base:
    build:
      context: .
      dockerfile: Dockerfile_base
      args:
        UBUNTU_MIRROR: http://mirrors.tuna.tsinghua.edu.cn/ubuntu/
        NPM_MIRROR: https://registry.npmmirror.com
    image: bili-search-base
  bili-seach-backend:
    depends_on:
      - bili-search-base
    build:
      context: .
      dockerfile: Dockerfile_backend
      args:
        PIP_MIRROR: https://pypi.tuna.tsinghua.edu.cn/simple
        COMMIT_HASH: 4d0b9f3e4363ee035bc0bdb2a61d6a5df69eb1aa
        BACKEND_PORT: 20001
    image: bili-search
    network_mode: host
    volumes:
      - ../bili-search/configs/secrets.json:/app/bili-search/configs/secrets.json
      - ../bili-search/configs/elastic_ca.crt:/app/bili-search/configs/elastic_ca.crt
  bili-seach-frontend:
    depends_on:
      - bili-search-base
    build:
      context: .
      dockerfile: Dockerfile_frontend
      args:
        NPM_MIRROR: https://registry.npmmirror.com
        COMMIT_HASH: f57cbb3a1df36b12cb8fb1a3e7d13560b534fc03
        DEV_BACKEND_PORT: 21001
        BACKEND_PORT: 20001
        DEV_FRONTEND_PORT: 21002
        FRONTEND_PORT: 20002
    image: bili-search-ui
    network_mode: host
# sudo usermod -aG docker $USER && newgrp docker
# docker compose up --build
